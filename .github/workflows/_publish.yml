on:
  workflow_dispatch:
  push:
    branches: main

name: Quarto Publish

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Debug renv setup
        run: |
          ls -la
          test -f renv.lock && echo "renv.lock exists" || echo "renv.lock NOT FOUND"
          test -d renv && echo "renv directory exists" || echo "renv directory NOT FOUND"
          test -f .Rprofile && echo ".Rprofile exists" || echo ".Rprofile NOT FOUND"
          grep -q "renv" .Rprofile 2>/dev/null && echo "renv in Rprofile" || echo "renv NOT in Rprofile"

      - name: Ensure .github directory exists with proper permissions
        run: |
          mkdir -p .github
          chmod 755 .github

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          working-directory: ${{ github.workspace }}

      - name: Cache TinyTeX
        id: tinytex-cache
        uses: actions/cache@v4
        with:
          path: ~/.TinyTeX
          key: ${{ runner.os }}-tinytex-v1

      - name: Set up TinyTeX
        uses: r-lib/actions/setup-tinytex@v2
        if: steps.tinytex-cache.outputs.cache-hit != 'true'

      - name: Render and publish to GitHub pages
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
